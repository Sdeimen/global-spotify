---
title: "INFO 523 - Association Rules"
author: "Noah Giebink and Sebastian Deimen"
date: "March 3, 2020"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# packages
library(tidyverse)
library(corrplot)
library(arules)
library(arulesViz)

# data
spot <- read_csv("spot_clean.csv")

```

## Choosing Variables


```{r}
# select relevant
spot <- spot %>% select(track.popularity,
                        danceability, energy, key, loudness, 
                        speechiness, acousticness, instrumentalness,
                        liveness, valence, tempo, duration_min,
                        happiness, median_age, percent_urban,
                        percent_internet_users, density_sqkm,
                        freedom, gdp)

spot_cor <- cor(spot) # make correlation matrix
corrplot(spot_cor, method = 'number', number.digits = 2,
         number.cex = 3/5) # find correlations by visualizing corrplot

```
Figure 1. Correlation plot to weed out highly correlated variables.


We set an arbitrary correlation coefficient threshold of +/-0.75 to weed out correlated variables. We removed energy, median_age, and percent_urban.

## Discretize variables
*track information variables:*
track.name, track.popularity 
*audio metrics:*
danceability, loudness, speechiness, acousticness, instrumentalness, liveness, valence, tempo, duration_min, 
*sociopolitical variables:*
happiness, percent_internet_users, density_sqkm, freedom, gdp

```{r, warning=FALSE}
# select remaining variables
spot <- spot %>% select(track.popularity,
                        danceability, loudness, 
                        speechiness, acousticness, instrumentalness,
                        liveness, valence, tempo, duration_min,
                        happiness,
                        percent_internet_users, density_sqkm,
                        freedom, gdp)
# Discretize variables
  # function to discretize variables
disc <- function(x){
  cut(x, breaks = 4, 
      labels = c('low', 'med-low', 'med-high', 'high'))}
  # apply disc fun to all dbl vars
spot_disc <- mutate_all(spot, funs(disc))

# plot distribution of levels for each variable
spot_long <- pivot_longer(spot_disc, cols = colnames(spot_disc),
                          names_to = 'variable', values_to = 'level')
ggplot(spot_long, aes(level))+
  geom_bar()+
  facet_wrap(~variable)+
  theme(axis.text.x = element_text(angle = 90))
```
Figure 2. Distribution of discretized levels across all variables.

Most variables have a decent spread of values after discretization, except for instrumentalness, liveness, and speechiness. Since we think this is due to their irrelevance to the top 50 tracks, we chose to omit these variables from association rule mining.

Our remaining variables are the following:

```{r}
# The remaining dataset
spot_disc <- select(spot_disc, -instrumentalness, -liveness, -speechiness)
variable.names(spot_disc)
```


## Make transactional database


### Inspect 
```{r}
# make transactional dataset
spot_trans <- as(spot_disc, 'transactions')
inspect(spot_trans[1])
```

### Plot
```{r}
itemFrequencyPlot(spot_trans, support = 0.2, cex.names = 0.8)

```
Figure 3. Most frequent itemsets (support above 0.2).

## Mine and Inspect Frequent Itemsets
```{r}
# frequent sets
sets <- apriori(spot_trans, parameter = list(support = 0.05, target = 'frequent itemsets'))
  # just closed
closed = sets[is.closed(sets)]
summary(closed)
  # just max
max = sets[is.maximal(sets)]
summary(max)

# inspect top 10 frequent itemsets
inspect(head(closed, n=10, by='support'))
```


## Mining for Rules
```{r}
rules <- apriori(spot_trans, parameter = list(support = 0.05, 
                                        confidence = 0.7,
                                        target = 'rules')) 
summary(rules)
# inspect returns table with columns lhs 'lefthand side', rhs 'rhs'
# can subset by certain attributes in lhs or rhs
inspect(head(rules, n=10, decreasing = TRUE, by = "lift"))


# get frequent colnames
music <- colnames(spot_trans[,1:28])
social <- colnames(spot_trans[,29:ncol(spot_trans)])

#select rules containing certain items
inspect(head(n = 20, subset(rules, subset=(rhs %in% music))))

inspect(head(n = 20, subset(rules, subset=(lhs %in% social & rhs %in% music))))

inspect(head(n = 20, by = 'lift', 
             subset(rules, subset=(lhs %in% social &
                                     !(lhs %in% music) & 
                                     rhs %in% music &
                                     size(lhs)>1))))


```


